# ------------------------------------------------------------------------
# OWASP ModSecurity Core Rule Set Plugin
# Copyright (c) 2021-2022 Core Rule Set project. All rights reserved.
#
# The OWASP ModSecurity Core Rule Set plugins are distributed under
# Apache Software License (ASL) version 2
# Please see the enclosed LICENSE file for full details.
# ------------------------------------------------------------------------

# OWASP CRS Plugin
# Plugin name: civicrm-rule-exclusions-plugin
# Plugin description: Rule Exclusions for CiviCRM.
# Rule ID block base: 9,800,000 (range is 1000, thus ID block base +1000)
# Plugin version: 1.0.0

# Generic rule to disable plugin
SecRule TX:civicrm-rule-exclusions-plugin_enabled "@eq 0" "id:9800099,phase:1,pass,nolog,ctl:ruleRemoveById=9800100-9800999"

# rule 9,800,100 : Disable SQL detection when we're using API4 AJAX (e.g. SearchKit, API Explorer, etc.).
SecRule REQUEST_FILENAME|ARGS:q "@contains civicrm/ajax/api4" \
    "id:9800100,\
    phase:2,\
    pass,\
    t:urlDecode,\
    nolog,\
    ctl:ruleRemoveTargetById=942190;ARGS:calls \
    ctl:ruleRemoveTargetById=932115;ARGS:params \
    ctl:ruleRemoveTargetById=942190;ARGS:params \
    ctl:ruleRemoveTargetById=942360;ARGS:params \
    ver:'civicrm-rule-exclusions-plugin/1.0.0'"

# rule 9,800,101 : Disable SQL detection when we're editing in FormBuilder.
SecRule REQUEST_FILENAME|ARGS:q "@endsWith civicrm/admin/afform" \
    "id:9800101,\
    phase:2,\
    pass,\
    t:urlDecode,\
    nolog,\
    ctl:ruleRemoveTargetById=932115;ARGS:params \
    ctl:ruleRemoveTargetById=942190;ARGS:params \
    ctl:ruleRemoveTargetById=942360;ARGS:params \
    ver:'civicrm-rule-exclusions-plugin/1.0.0'"

# rule 9,800,102 : Don't block crm.profile-selector.js just because `.profile` is in the name.
SecRule REQUEST_FILENAME|ARGS:q "@contains crm.profile-selector.js" \
    "id:9800102,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=930130 \
    ver:'civicrm-rule-exclusions-plugin/1.0.0'"

# rule 9,800,900 : Allow PHP information leakage for debugging purposes.
SecAction \
    "id:9800900,\
    phase:4,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=953100 \
    ctl:ruleRemoveById=953110 \
    ver:'civicrm-rule-exclusions-plugin/1.0.0'"
